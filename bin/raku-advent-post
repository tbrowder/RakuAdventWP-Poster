#!/usr/bin/env raku
# Convert a .rakudoc and upload in one shot.
#
# CREDENTIAL CHECKLIST (raku-advent.blog):
# 1) You have a WordPress user on the site.
# 2) Your role is Author (or higher).
# 3) Create an Application Password in your WP profile.
# 4) Prefer env var RAKU_ADVENT_APP_PASS for secrets.
#
# Config order: CLI > ENV > ~/.config/raku-advent/config.json
use v6.d;
use RakuAdventWP::Poster :convert-rakudoc-to-html, :upload, :load-config;

sub USAGE {
    say q:to/HELP/;
Usage:
  raku-advent-post --in FILE.rakudoc --title "Post Title"
    [--status draft|publish|future]     # default: draft
    [--slug my-slug]
    [--excerpt "Short summary"]
    [--sticky yes|no]                   # default no

    # Taxonomies (mixable; default to config if omitted)
    [--cats "12,34"]                    # numeric IDs
    [--tags "56,78"]
    [--cat-names "Advent, Raku"]        # names
    [--tag-names "Tutorial, 2025"]
    [--create-tax yes|no]               # default yes

    # Featured image
    [--featured path/to/img.png]
    [--featured-alt "Alt text"]

    # Author
    [--author-id 7]
    [--author-name "Jane Doe"]
    [--author-login "janed"]
    [--author-email "jane@example.com"]

    # Scheduling
    [--date "YYYY-MM-DD HH:MM"]         # site local time
    [--date-gmt "YYYY-MM-DD HH:MM"]     # UTC

    # Optional config overrides
    [--site https://example.com]
    [--user you@example.com]
    [--app-pass "APP PASSWORD"]
HELP
    exit 1;
}

# Parse --key value pairs
my %opt;
for @*ARGS.rotor(2, :partial).grep(*.elems == 2) -> [$k,$v] {
    %opt{$k} = $v if $k ~~ /^ '--' <-[=]>+ $/;
}

my $in-file = %opt{'--in'} // USAGE();
my $title   = %opt{'--title'} // USAGE();

# Load config with possible CLI overrides for creds
my %cfg = load-config(
    site       => %opt{'--site'},
    user       => %opt{'--user'},
    'app-pass' => %opt{'--app-pass'},
);

my $site     = %cfg<site>     // USAGE();
my $user     = %cfg<user>     // USAGE();
my $app-pass = %cfg<app-pass> // USAGE();

# Convert the rakudoc
my $raw = try slurp $in-file;
die "Cannot read $in-file\n" unless $raw.defined and $raw.chars;
my $html = convert-rakudoc-to-html($raw);

# Basic fields
my $status  = %opt{'--status'} // 'draft';
my $slug    = %opt{'--slug'} // Nil;
my $excerpt = %opt{'--excerpt'} // Nil;
my $sticky  = (%opt{'--sticky'} // 'no').lc eq 'yes';

# Taxonomies
my $cats       = %opt{'--cats'} // Nil;
my $tags       = %opt{'--tags'} // Nil;
my $cat-names  = %opt{'--cat-names'} // Nil;
my $tag-names  = %opt{'--tag-names'} // Nil;
my $create-tax = (%opt{'--create-tax'} // 'yes').lc eq 'yes';

# Defaults from config if still empty
if (!$cats and !$cat-names and %cfg<default-cats> and %cfg<default-cats>.chars) {
    $cat-names = %cfg<default-cats>;
}
if (!$tags and !$tag-names and %cfg<default-tags> and %cfg<default-tags>.chars) {
    $tag-names = %cfg<default-tags>;
}

# Media
my $featured     = %opt{'--featured'} // Nil;
my $featured-alt = %opt{'--featured-alt'} // Nil;

# Author
my $author-id    = %opt{'--author-id'} // Nil;
my $author-name  = %opt{'--author-name'} // Nil;
my $author-login = %opt{'--author-login'} // Nil;
my $author-email = %opt{'--author-email'} // Nil;

# Scheduling
my $date     = %opt{'--date'} // Nil;
my $date-gmt = %opt{'--date-gmt'} // Nil;

# Upload
my %res = upload(
    site         => $site,
    user         => $user,
    'app-pass'   => $app-pass,
    title        => $title,
    content      => $html,
    status       => $status,
    slug         => $slug,
    excerpt      => $excerpt,
    sticky       => $sticky,
    cats         => $cats,
    tags         => $tags,
    'cat-names'  => $cat-names,
    'tag-names'  => $tag-names,
    'create-tax' => $create-tax,
    featured     => $featured,
    'featured-alt' => $featured-alt // '',
    'author-id'    => $author-id,
    'author-name'  => $author-name,
    'author-login' => $author-login,
    'author-email' => $author-email,
    date         => $date,
    'date-gmt'   => $date-gmt,
);

say "OK: Post ID {%res<id> // '?'} status {%res<status> // '?'}";
say "Link: {%res<link>}" if %res<link>:exists;
